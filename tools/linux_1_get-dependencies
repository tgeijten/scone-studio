#!/usr/bin/env bash

set -exuo pipefail

system_dependencies=(
    cmake
    make

    # for 'fpm'
    ruby
    ruby-dev
    rubygems

    # for scone
    freeglut3-dev
    libxi-dev
    libxmu-dev
    liblapack-dev
    libqt5widgets5
    libqt5opengl5-dev
    qt5-default
    libopenscenegraph-3.4-dev
)
OPENSIM_HOME="${PWD}/opensim-core"
OSC_SOURCEFORGE_FILES="https://sourceforge.net/projects/dependencies/files/opensim-core"
OSC_TARBALL_NAME="opensim-core-3.3-ubuntu-18.04.tar.xz"

# only install g++/gcc if the user hasn't already installed them
# (e.g. because it's a fresh computer) AND the user hasn't specified a
# custom compiler override (e.g. by setting CC/CXX to 'clang').
if [[ -z "${CXX:-}" ]]; then
    if ! command -v g++; then
        system_dependencies+=(g++)
    fi
fi

if [[ -z "${CC:-}" ]]; then
    if ! command -v gcc; then
        system_dependencies+=(gcc)
    fi
fi


echo "installing system-level dependencies"
sudo apt-get update && sudo apt-get install ${system_dependencies[@]}

echo "installing fpm (used to create packages)"
sudo gem install --no-document fpm

echo "installing opensim3"
if [ -d "${OPENSIM_HOME}" ]; then
    echo "OPENSIM_HOME (${OPENSIM_HOME}): already exists: skipping"
else
    echo "${OPENSIM_HOME}: does not exist, fetching binary from sourceforge"

    wget "${OSC_SOURCEFORGE_FILES}/${OSC_TARBALL_NAME}"
    tar -xf "${OSC_TARBALL_NAME}"
    echo "${OSC_TARBALL_NAME}: unpacked"
    ls opensim-core/
fi
