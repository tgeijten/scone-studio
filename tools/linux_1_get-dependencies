#!/usr/bin/env bash

set -exuo pipefail

system_dependencies=(
    # for 'git submodule'
    git

    cmake
    make

    # for 'fpm'
    ruby
    ruby-dev
    rubygems

    # for 'scone{studio,cmd}'
    freeglut3-dev
    libxi-dev
    libxmu-dev
    liblapack-dev
    libqt5widgets5
    libqt5opengl5-dev
    qt5-default
)
OPENSIM_HOME="${PWD}/opensim-core"
OSC_SOURCEFORGE_FILES="https://sourceforge.net/projects/dependencies/files/opensim-core"
OSC_TARBALL_NAME="opensim-core-3.3-ubuntu-18.04.tar.xz"

# only install g++/gcc if the user hasn't already installed them
# (e.g. because it's a fresh computer) AND the user hasn't specified a
# custom compiler override (e.g. by setting CC/CXX to 'clang').
if [[ -z "${CXX:-}" ]]; then
    if ! command -v g++; then
        system_dependencies+=(g++)
    fi
fi

if [[ -z "${CC:-}" ]]; then
    if ! command -v gcc; then
        system_dependencies+=(gcc)
    fi
fi

# if root is running this script then do not use `sudo` (some distros
# do not supply it)
if [[ "${UID}" == 0 ]]; then
    sudo=''
else
    sudo='sudo'
fi

echo "installing system-level dependencies"
${sudo} apt-get update && ${sudo} apt-get install -y ${system_dependencies[@]}

echo "installing fpm (used to create packages)"
${sudo} gem install --no-document fpm

# TODO: upload prebuilt openscenegraph with libpng16 onto sourceforce
# 
#echo "installing openscenegraph 3.4"
#if [ -d "OpenSceneGraph-3.4" ]; then
#    echo "OpenSceneGraph-3.4/: already exists: skipping"
#else
#    wget https://sourceforge.net/projects/dependencies/files/OpenSceneGraph/OpenSceneGraph-3.4-ubuntu-18.04.tar.xz
#    tar xvf OpenSceneGraph-3.4-ubuntu-18.04.tar.xz
#fi

echo "installing opensim3"
if [ -d "${OPENSIM_HOME}" ]; then
    echo "OPENSIM_HOME (${OPENSIM_HOME}): already exists: skipping"
else
    echo "${OPENSIM_HOME}: does not exist, fetching binary from sourceforge"

    wget "${OSC_SOURCEFORGE_FILES}/${OSC_TARBALL_NAME}"
    tar -xf "${OSC_TARBALL_NAME}"
    echo "${OSC_TARBALL_NAME}: unpacked"
    ls opensim-core/
fi

echo "getting submodule dependencies"
git submodule update --init --recursive
