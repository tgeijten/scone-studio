#!/usr/bin/env bash

set -euo pipefail

export OPENSIM_HOME="${OPENSIM_HOME:-${PWD}/opensim-core}"
export PATH="${OPENSIM_HOME}/bin:${PATH}"
export LD_LIBRARY_PATH="${OPENSIM_HOME}/lib:${LD_LIBRARY_PATH:-}"
CMAKE_BUILD_TYPE="${CMAKE_BUILD_TYPE:-Release}"
NUM_BUILD_JOBS="${NUM_BUILD_JOBS:-$(nproc)}"

if ! command -v osgwindows; then
    echo "osgwindows: no such command: this binary is from the (expected) 'openscenegraph' dependency" 1>&2
    echo "have installed dependencies before running this build? try with:" 1>&2
    echo "    ./tools/install-dependencies" 1>&2
    exit 1
fi

if [ ! -d "${OPENSIM_HOME}" ]; then
    echo "OPENSIM_HOME (${OPENSIM_HOME}): does not exist: must be set to a directory containing OpenSim3" 1>&2
    echo "have you installed dependencies before running this build? try with:" 1>&2
    echo "    ./tools/install-dependencies" 1>&2
    exit 1
fi

set -x
git submodule update --init --recursive
mkdir -p build/
project_dir="${PWD}"

pushd build/
set +x
cmake ../ \
      -DCMAKE_BUILD_TYPE="${CMAKE_BUILD_TYPE}" \
      -DCMAKE_VERBOSE_MAKEFILE=TRUE \
      -DCMAKE_INSTALL_PREFIX="${project_dir}/install" \
      -DCMAKE_PREFIX_PATH="/usr/lib/x86_64-linux-gnu/" \
      -DOPENSIM_INSTALL_DIR="${OPENSIM_HOME}" \
      -DOPENSIM_INCLUDE_DIR="${OPENSIM_HOME}/sdk/include"
make "-j${NUM_BUILD_JOBS}"
popd
